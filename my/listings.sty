\usepackage[final]{listings}%
  \def\codefont{\ttfamily}%
  \newcommand\q[1]{{\codefont #1}}%
  \newcommand\qq[1]{`\q{#1}'}%
  \lstloadlanguages{Python}%
  \lstset{language=Python,%
          %fancyvrb,%
          escapechar=|,% "|" is almost unused in Python
          basicstyle=\codefont,%
          commentstyle=\normalfont\small,%
          texcl,mathescape=true,%
          showspaces=false,%
          showstringspaces=false,%
          xleftmargin=2em,%
          numbers=left,%
          numberstyle=\tiny,%
          stepnumber=1,%
          firstnumber=last%
        }%
  \lstnewenvironment{code}{}{}%
  \lstnewenvironment{codexmp}{\lstset{numbers=none,xleftmargin=1em}}{}%
  \newcommand{\n}[1]{\begingroup\def\x{\csname label\endcsname{l:#1}}\x\endgroup}
  \newcommand{\nr}[1]{\begingroup\def\x{\csname ref\endcsname{l:#1}}\x\endgroup}
