%% LaTeX2e style file for `context-sensitive' labels.
%%
%% v0.2.1 -- 2001-11-28  Riccardo Murri
%%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{csref}
[2001/11/28 Typeset reference basing on environment containing the label]
%%
%% Preliminary declarations
%%
\let\csr@ref=\ref% just to provide a default; may be overridden by options
%%
%% Options
%%
\DeclareOption{varioref}{%
  \RequirePackage{varioref}%
  \let\csr@ref=\vref%
}
\DeclareOption{fancyref}{%
  \RequirePackage{fancyref}%
  \let\csr@ref=\fref%
}
\ProcessOptions\relax
%%
%% The following code is more or less taken from The TeXBook, p.378
%%
\newtoks\csr@tempa \newtoks\csr@tempb
\def\csr@leftappend#1#2{%
  \csr@tempa={\@elt{#1}}%
  \csr@tempb=\expandafter{#2}%
  \xdef#2{\the\csr@tempa\the\csr@tempb}%
}
\def\csr@addtocontexts#1{\csr@leftappend#1\csr@contexts}%
\def\csr@contexts{}%
\def\newcsref#1{%
  \expandafter\csr@addtocontexts\csname #1\endcsname%
  \@namedef{csr@#1@label}##1{%
    \expandafter\global\@namedef{csr@##1@ref}{%
      \csname csr@#1@refcmd\endcsname{##1}}%
    }%
  \@namedef{csr@#1@refcmd}##1%
}%
\newcommand*\renewcsref[1]{%
  \expandafter\csr@addtocontexts\csname #1\endcsname%
  \@namedef{csr@#1@label}##1{%
    \expandafter\global\@namedef{csr@##1@ref}{%
      \csname csr@#1@refcmd\endcsname{##1}}%
    }%
  \@namedef{csr@#1@refcmd}##1%
}%
\newif\ifcsr@contextnotfound%
\csr@contextnotfoundtrue% pessimistic default
\def\csr@read@context{%
  \xdef\csr@current{\expandafter\noexpand\csname\@currenvir\endcsname}%
}%
\def\csr@context@check#1{%
  \csr@read@context% 
  \expandafter\ifx\csr@current#1%
    \csr@contextnotfoundfalse% pheeew!
    \expandafter\aftergroup%
      \csname csr@\expandafter\@gobble\string#1@label\endcsname%
  \fi%
}%
\DeclareRobustCommand*\cslabel[1]{%
  \begingroup%
    \let\@elt=\csr@context@check%
    \csr@contexts%
    \ifcsr@contextnotfound%
      \PackageWarning{csref}{Environment `\@currenvir' unknown;\space%
        using default reference format}%
      \aftergroup\csr@default@label%
    \fi%
    \endgroup{#1}%
    \csr@saved@label{#1}%
}%
\DeclareRobustCommand*\csref[1]{\csname csr@#1@ref\endcsname}%
%
\AtBeginDocument{% we need to do this *after* hyperref, refcheck, etc.
  \let\csr@saved@label=\label%
  \let\label=\cslabel%
}%
%
%
%
\newcsref{default}{\csr@ref{#1}}%
\providecommand\refsectionname{Section}%
\ifx\sectionname\@empty% hack for AMS document classes
  \newcsref{document}{\refsectionname~\csr@ref{#1}}%
\else%
  \newcsref{document}{\sectionname~\csr@ref{#1}}%
\fi%
%
\def\newcsref@ifdefined#1{%
  \@ifundefined{#1}
    {\@gobble}% eat up second argument
    {\newcsref{#1}}% define a new \csref
}%
\newcsref@ifdefined{theorem}{\theoremname~\csr@ref{#1}}%
\newcsref@ifdefined{lemma}{Lemma~\csr@ref{#1}}%
\newcsref@ifdefined{proposition}{Proposition~\csr@ref{#1}}%
\newcsref@ifdefined{claim}{Claim~\csr@ref{#1}}%
\newcsref@ifdefined{conjecture}{Conjecture~\csr@ref{#1}}%
\newcsref@ifdefined{example}{Example~\csr@ref{#1}}%
\newcsref@ifdefined{definition}{Definition~\csr@ref{#1}}%
\newcsref@ifdefined{corollary}{Corollary~\csr@ref{#1}}%
\newcsref@ifdefined{remark}{Remark~\csr@ref{#1}}%
\newcsref@ifdefined{figure}{\figurename~\csr@ref{#1}}%
\newcsref@ifdefined{table}{\tablename~\csr@ref{#1}}%
\newcsref@ifdefined{enumerate}{\csr@ref{#1}}%
\newcsref@ifdefined{itemize}{\csr@ref{#1}}%
% \newcsref@ifdefined{app}{Appendix}% <-- FIXME!!

